test:php-unit:
  image: registry.gitlab.com/acp3/php-docker:${PHP_VERSION}
  stage: test
  cache:
    key: $CI_JOB_NAME
    paths:
      - tests/.phpunit.result.cache
  script:
    - composer test-with-coverage
  coverage: '/^\s*Lines:\s*\d+.\d+\%/'
  needs:
    - composer
  artifacts:
    paths:
      - junit-report.xml
    reports:
      junit: junit-report.xml
    when: always
  rules:
    - !reference [.gitlab-ci-changes, rules]
    - !reference [.php-changes, rules]
    - !reference [.phpunit-changes, rules]
  parallel:
    matrix:
      - PHP_VERSION: "8.1"

test:php-cs-fixer:
  image: registry.gitlab.com/acp3/php-docker:8.1
  stage: test
  cache:
    key: $CI_JOB_NAME
    paths:
      - .php-cs-fixer.cache
  script:
    - composer run-script lint
  needs:
    - composer
  rules:
    - !reference [.gitlab-ci-changes, rules]
    - !reference [.php-changes, rules]
    - !reference [.php-cs-fixer-changes, rules]

test:phpstan:
  image: registry.gitlab.com/acp3/php-docker:8.1
  stage: test
  cache:
    key: $CI_JOB_NAME
    paths:
      - .phpstan-cache
  script:
    - php -d memory_limit=-1 vendor/bin/phpstan analyse --no-progress
  needs:
    - composer
  rules:
    - !reference [.gitlab-ci-changes, rules]
    - !reference [.php-changes, rules]
    - !reference [.phpstan-changes, rules]
