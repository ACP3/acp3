composer:
  image: composer:2
  stage: prepare
  cache:
    key: $CI_JOB_NAME
    paths:
      - ${COMPOSER_HOME}
      - vendor
  script:
    - composer install -n --prefer-dist --ignore-platform-reqs
  artifacts:
    paths:
      - vendor
  rules:
    - !reference [.gitlab-ci-changes, rules]
    - !reference [.php-changes, rules]
    - !reference [.phpunit-changes, rules]
    - !reference [.php-cs-fixer-changes, rules]
    - !reference [.phpstan-changes, rules]

npm:
  image: node:lts-alpine
  stage: prepare
  cache:
    key:
      prefix: $CI_JOB_NAME
      files:
        - package.json
        - package-lock.json
    paths:
      - .npm
      - node_modules
  before_script:
    - apk update && apk add --no-cache git
  script:
    - if [ ! -d "node_modules" ]; then npm ci --cache .npm --prefer-offline; fi
  artifacts:
    paths:
      - node_modules
  rules:
    - !reference [.gitlab-ci-changes, rules]
    - !reference [.npm-changes, rules]
    - !reference [.prettier-changes, rules]
    - !reference [.eslint-changes, rules]
    - !reference [.stylelint-changes, rules]
