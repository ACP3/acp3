language: php
sudo: required
dist: trusty
group: edge
php:
  - 7.1
  - nightly

matrix:
  fast_finish: true
  allow_failures:
    - php: nightly

addons:
  code_climate:
    repo_token: ${CC_REPO_TOKEN}

before_install:
  - echo -e "machine github.com\n\tlogin ${ACP3_CI_USER_GH_TOKEN}" >> ~/.netrc

before_script:
  - ./build/travis/before_script.sh ${ACP3_CI_USER_GH_TOKEN} ${TRAVIS_PHP_VERSION}

script:
  - phpdbg -qrr ./vendor/bin/phpunit -c ./tests/phpunit.dist.xml --coverage-clover ./build/logs/clover.xml

after_success:
  - travis_retry vendor/bin/coveralls -v

before_deploy:
  - ./build/travis/generate_artifact.sh ${TRAVIS_PHP_VERSION}

deploy:
  - provider: releases
    api_key: ${ACP3_CI_USER_GH_TOKEN}
    file: 'release.zip'
    skip_cleanup: true
    on:
      tags: true
      condition: "$TRAVIS_PHP_VERSION = 7.1*"

cache:
  directories:
    - vendor
    - $HOME/.composer/cache
