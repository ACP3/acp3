language: php
sudo: required
dist: trusty
group: edge
php:
  - 5.6
  - 7.0.8
  - 7.1
  - nightly
  - hhvm

matrix:
  fast_finish: true
  allow_failures:
    - php: nightly
    - php: hhvm

addons:
  code_climate:
    repo_token: ${CC_REPO_TOKEN}

before_install:
  - echo -e "machine github.com\n\tlogin ${ACP3_CI_USER_GH_TOKEN}" >> ~/.netrc

before_script:
  - ./build/travis/before_script.sh ${ACP3_CI_USER_GH_TOKEN} ${TRAVIS_PHP_VERSION}

script:
  - ./build/travis/run_unit_tests.sh ${TRAVIS_PHP_VERSION}

after_script:
  - ./build/travis/push_code_coverage.sh ${TRAVIS_PHP_VERSION}

before_deploy:
  - ./build/travis/generate_artifact.sh ${TRAVIS_PHP_VERSION}

deploy:
  - provider: releases
    api_key: ${ACP3_CI_USER_GH_TOKEN}
    file: 'release.zip'
    skip_cleanup: true
    on:
      tags: true
      condition: "$TRAVIS_PHP_VERSION = '7.0'"
  - provider: script
    script: ./build/travis/update_module_repositories.sh ${TRAVIS_TAG}
    skip_cleanup: true
    on:
      tags: true
      condition: "$TRAVIS_PHP_VERSION = '7.0'"
  - provider: script
    script: ./build/travis/update_version_check.sh ${TRAVIS_TAG}
    skip_cleanup: true
    on:
      tags: true
      condition: "$TRAVIS_PHP_VERSION = '7.0'"

cache:
  directories:
    - vendor
    - $HOME/.composer/cache
