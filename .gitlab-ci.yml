image: php:7.1

variables:
  COMPOSER_HOME: .composerhome
  COMPOSER_ALLOW_SUPERUSER: 1

cache:
  key: $CI_COMMIT_REF_NAME
  paths:
  - ${COMPOSER_HOME}
  - vendor

before_script:
  - bash ./build/gitlab/before_script.sh > /dev/null

stages:
  - test
  - split

test:php:
  stage: test
  before_script:
    - bash ./build/gitlab/before_script.sh > /dev/null
    - bash ./build/gitlab/before_script_php.sh > /dev/null
    - curl --silent --show-error https://getcomposer.org/installer | php
    - php composer.phar global require hirak/prestissimo
  script:
    - php composer.phar install -n -o
    - php ./vendor/bin/phpunit -c ./tests/phpunit.dist.xml

split:
  image: jderusse/gitsplit
  stage: split
  cache:
    key: "$CI_JOB_NAME/$CI_COMMIT_REF_NAME"
    paths:
      - .gitsplit-cache
  variables:
    GIT_STRATEGY: clone
  script:
    - git config remote.origin.fetch "+refs/*:refs/*"
    - git config remote.origin.mirror true
    - git fetch
    - gitsplit
