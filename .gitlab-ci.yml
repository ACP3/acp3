image: php:7.1

variables:
  COMPOSER_HOME: .composerhome
  COMPOSER_ALLOW_SUPERUSER: 1

cache:
  key: $CI_COMMIT_REF_NAME
  paths:
  - ${COMPOSER_HOME}
  - vendor

before_script:
  - bash ./build/gitlab/before_script.sh > /dev/null

stages:
  - test
  - split

test:php-unit:
  stage: test
  before_script:
    - bash ./build/gitlab/before_script.sh > /dev/null
    - bash ./build/gitlab/before_script_php.sh > /dev/null
    - pecl install xdebug
    - docker-php-ext-enable xdebug
  script:
    - php composer.phar install -n -o
    - php ./vendor/bin/phpunit -c ./tests/phpunit.dist.xml --coverage-text --colors=never
  coverage: '/^\s*Lines:\s*\d+.\d+\%/'

test:phpcs:
  stage: test
  before_script:
    - bash ./build/gitlab/before_script.sh > /dev/null
    - bash ./build/gitlab/before_script_php.sh > /dev/null
  script:
    - php composer.phar install -n -o
    - php composer.phar run-script lint

split:
  image: jderusse/gitsplit
  stage: split
  cache:
    key: "$CI_JOB_NAME/$CI_COMMIT_REF_NAME"
    paths:
      - .gitsplit-cache
  variables:
    GIT_STRATEGY: clone
  before_script:
    - eval $(ssh-agent -s)
    - mkdir -p ~/.ssh
    - 'echo -e "Host *\n\tStrictHostKeyChecking no\n\n" > ~/.ssh/config'
    - ssh-add <(echo "$SSH_PRIVATE_KEY")
    - ssh-add -l
  script:
    - git config remote.origin.fetch "+refs/*:refs/*"
    - git config remote.origin.mirror true
    - git fetch
    - gitsplit
