variables:
  COMPOSER_HOME: .composerhome
  COMPOSER_ALLOW_SUPERUSER: 1
  npm_config_cache: .npmhome

stages:
  - build
  - test
  - release

.php-base:
  image: registry.gitlab.com/acp3/php-docker:7.2
  cache:
    key: composer-$CI_COMMIT_REF_NAME
    paths:
      - ${COMPOSER_HOME}
      - vendor
      - .php_cs.cache

build:composer:
  extends: .php-base
  stage: build
  script:
    - composer install -n --prefer-dist

test:php71-unit:
  extends: test:php72-unit
  image: registry.gitlab.com/acp3/php-docker:7.1
  coverage: ~

test:php72-unit:
  extends: .php-base
  stage: test
  cache:
    policy: pull
  script:
    - phpdbg -qrr ./vendor/bin/phpunit -c ./tests/phpunit.dist.xml --coverage-text --colors=never
  coverage: '/^\s*Lines:\s*\d+.\d+\%/'

test:php73-unit:
  extends: test:php72-unit
  image: registry.gitlab.com/acp3/php-docker:7.3
  coverage: ~

test:phpcs:
  extends: .php-base
  stage: test
  script:
    - composer run-script lint

test:phpstan:
  extends: .php-base
  stage: test
  cache:
    policy: pull
  script:
    - php -d memory_limit=-1 vendor/bin/phpstan analyse --no-progress

test:eslint:
  image: node:lts-alpine
  stage: test
  cache:
    key: node-$CI_COMMIT_REF_NAME
    paths:
      - ${npm_config_cache}
  before_script:
    - apk update && apk add --no-cache git
  script:
    - npm ci
    - npm run-script eslint

release:subtree-split:
  image: jderusse/gitsplit
  stage: release
  cache:
    key: "$CI_JOB_NAME"
    paths:
      - .gitsplit-cache
  variables:
    GIT_STRATEGY: clone
  before_script:
    - eval $(ssh-agent -s)
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - echo -e "Host *\n\tStrictHostKeyChecking no\n\n" > ~/.ssh/config
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add - > /dev/null
    - ssh-add -l
  script:
    - git config remote.origin.fetch "+refs/*:refs/*"
    - git config remote.origin.mirror true
    - git fetch --prune --unshallow || git fetch --prune
    - gitsplit --ref "${CI_COMMIT_REF_NAME}"

release:generate-artifact:
  extends: .php-base
  stage: release
  cache:
    policy: pull
  script:
    - composer install --no-dev --prefer-dist -o -n --ignore-platform-reqs
  artifacts:
    name: "release-${CI_COMMIT_TAG}"
    paths:
      - ACP3
      - bin
      - build/gulp
      - designs
      - installation
      - tests
      - uploads
      - vendor
      - .editorconfig
      - .htaccess.sample
      - CHANGELOG.md
      - composer.json
      - composer.lock
      - gulpfile.js
      - index.php
      - LICENSE
      - package.json
      - package-lock.json
      - README.md
  only:
    - tags
