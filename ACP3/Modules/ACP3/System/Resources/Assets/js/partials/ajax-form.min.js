"use strict";/*
 * Copyright (c) by the ACP3 Developers.
 * See the LICENSE file at the top-level module directory for licencing details.
 */(function(a,b,c){'use strict';function d(b,c){this.element=b,this.isFormValid=!0,this.settings=a.extend({},e,c),this._defaults=e,this._name="formSubmit",this.init()}var e={targetElement:"#content",loadingOverlay:!0,loadingText:"",customFormData:null,scrollOffsetElement:null};a.extend(d.prototype,{init:function init(){var b=this;this.mergeSettings(),this.findSubmitButton(),this.addLoadingLayer(),this.element.noValidate=!0,a(this.element).on("submit",function(d){d.preventDefault(),b.isFormValid=!0,a(c).trigger("acp3.ajaxFrom.submit.before",[b]),b.isFormValid&&b.preValidateForm(b.element)&&b.processAjaxRequest()}).on("click",function(c){"A"===a(this).prop("tagName")&&(c.preventDefault(),b.processAjaxRequest())}).on("change",function(){!1===b.isFormValid&&(b.removeAllPreviousErrors(b.element),b.checkFormElementsForErrors(b.element))})},mergeSettings:function mergeSettings(){var b=a(this.element).data();for(var c in b)if(b.hasOwnProperty(c)){var d=this.lowerCaseFirstLetter(c.replace("ajaxForm",""));0<d.length&&"undefined"!=typeof this.settings[d]&&(this.settings[d]=b[c])}},lowerCaseFirstLetter:function lowerCaseFirstLetter(a){return a.charAt(0).toLowerCase()+a.slice(1)},findSubmitButton:function findSubmitButton(){a(this.element).find(":submit").click(function(){a(":submit",a(this).closest("form")).removeAttr("data-clicked"),a(this).attr("data-clicked","true")})},preValidateForm:function preValidateForm(a){return this.removeAllPreviousErrors(a),this.checkFormElementsForErrors(a),this.focusTabWithFirstErrorMessage(a),this.scrollToFirstFormError(),this.isFormValid},removeAllPreviousErrors:function removeAllPreviousErrors(b){a(b).find(".is-invalid").removeClass(".is-invalid"),a(b).find(".invalid-feedback").remove()},checkFormElementsForErrors:function checkFormElementsForErrors(b){for(var c,d=0;d<b.elements.length;d++)(c=b.elements[d],"INPUT"===c.nodeName||"TEXTAREA"===c.nodeName||"SELECT"===c.nodeName)&&(c.checkValidity()||(this.addErrorMessageToFormField(a(c),c.validationMessage),this.isFormValid=!1))},removeErrorMessageFromFormField:function removeErrorMessageFromFormField(a){a.closest("div").find(".invalid-feedback").remove()},addErrorMessageToFormField:function addErrorMessageToFormField(a,b){this.removeErrorMessageFromFormField(a),a.addClass("is-invalid");a.closest("div:not(.input-group):not(.btn-group)").append("<div class=\"invalid-feedback d-block\"><i class=\"fas fa-exclamation-triangle\"></i> "+b+"</div>")},focusTabWithFirstErrorMessage:function focusTabWithFirstErrorMessage(b){var c=a(b),d=c.find(".nav-tabs");if(0<d.length){var e=c.find(".tab-content .form-group:has(.invalid-feedback):first"),f=e.closest(".tab-pane").prop("id");d.find(".nav-link[href=\"#"+f+"\"]").tab("show"),e.find(":input").focus()}},processAjaxRequest:function processAjaxRequest(){var d,e,f=this,g=a(this.element),h=!a.isEmptyObject(this.settings.customFormData),i=!0,j=this.settings.customFormData||{};if(g.attr("method")){if(e=a(":submit[data-clicked=\"true\"]",g),d=e.data("hashChange"),j=new FormData(g[0]),e.length&&j.append(e.attr("name"),1),h)for(var k in this.settings.customFormData)this.settings.customFormData.hasOwnProperty(k)&&j.append(k,this.settings.customFormData[k]);i=!1}else d=g.data("hashChange");a.ajax({url:g.attr("action")||g.attr("href"),type:g.attr("method")?g.attr("method").toUpperCase():"GET",data:j,processData:i,contentType:!!i&&"application/x-www-form-urlencoded; charset=UTF-8",beforeSend:function beforeSend(){f.showLoadingLayer(e),f.disableSubmitButton(e)}}).done(function(a){try{var c=g.data("ajax-form-complete-callback");"function"==typeof b[c]?b[c](a):a.redirect_url?f.redirectToNewPage(d,a):(f.scrollIntoView(),f.replaceContent(d,a),f.rebindHandlers(d),"undefined"!=typeof d&&(b.location.hash=d))}catch(a){console.error(a.message)}}).fail(function(b){400===b.status?(f.handleFormErrorMessages(g,b.responseText),f.scrollToFirstFormError(),a(c).trigger("acp3.ajaxFrom.submit.fail",[f])):0<b.responseText.length&&(c.open(),c.write(b.responseText),c.close())}).always(function(){f.hideLoadingLayer(),f.enableSubmitButton(e)})},addLoadingLayer:function addLoadingLayer(){if(!1!==this.settings.loadingOverlay){var b=a("#loading-layer");if(0===b.length){var c=a("body"),d=this.settings.loadingText||"";a("<div id=\"loading-layer\" class=\"loading-layer\"><h1><span class=\"fas fa-cog fa-spin\"></span>"+d+"</h1></div>").appendTo(c)}}},showLoadingLayer:function showLoadingLayer(){a("#loading-layer").addClass("loading-layer__active")},disableSubmitButton:function disableSubmitButton(a){"undefined"!=typeof a&&a.prop("disabled",!0)},enableSubmitButton:function enableSubmitButton(a){"undefined"!=typeof a&&a.prop("disabled",!1)},redirectToNewPage:function redirectToNewPage(a,c){"undefined"==typeof a?b.location.href=c.redirect_url:(b.location.href=c.redirect_url+a,b.location.reload())},/**
         * Scroll to the beginning of the content area, if the current viewport is near the bottom
         */scrollIntoView:function scrollIntoView(){var b=a(this.settings.targetElement).offset().top;a(c).scrollTop()>b&&a("html, body").animate({scrollTop:b},"fast")},replaceContent:function replaceContent(b,c){b&&a(b).length?a(b).html(a(c).find(b).html()):a(this.settings.targetElement).html(c)},rebindHandlers:function rebindHandlers(b){var c=b&&a(b).length?a(b):a(this.settings.targetElement);c.find("[data-ajax-form=\"true\"]").formSubmit(),this.findSubmitButton()},hideLoadingLayer:function hideLoadingLayer(){a("#loading-layer").removeClass("loading-layer__active")},handleFormErrorMessages:function handleFormErrorMessages(b,c){var d=a("#error-box"),e=b.find(".modal-body");// Place the error messages inside the modal body for a better styling
d.remove(),d=a(c),d.hide().prependTo(0<e.length&&e.is(":visible")?e:b).fadeIn(),this.prettyPrintResponseErrorMessages(b,d)},prettyPrintResponseErrorMessages:function prettyPrintResponseErrorMessages(b,c){var d=this;// highlight all input fields where the validation has failed
this.removeAllPreviousErrors(d.element),c.find("li").each(function(){var c=a(this),e=c.data("error");if(0<e.length){var f=b.find("#"+e)||b.find("[id|=\""+e+"\"]").filter(":not([id$=\"container\"])");0<f.length&&1===f.length&&(d.addErrorMessageToFormField(f,c.html()),c.remove())}}),0===c.find("li").length&&c.remove(),this.focusTabWithFirstErrorMessage(d.element)},scrollToFirstFormError:function scrollToFirstFormError(){var b=a(this.element),c=b.find(".form-group.has-error");if(c&&0!==c.length&&!this.isElementInViewport(b.find(".help-block.validation-failed"))){var d=c.offset().top;if(this.settings.scrollOffsetElement){var e=a(this.settings.scrollOffsetElement);e&&0<e.length&&(d-=e.height())}a("html, body").animate({scrollTop:d},"fast")}},isElementInViewport:function isElementInViewport(d){"function"==typeof jQuery&&d instanceof jQuery&&(d=d[0]);var e=a(this.settings.scrollOffsetElement),f=0;e&&(f=e.height());var g=d.getBoundingClientRect();return g.top>=f&&0<=g.left&&g.bottom<=(b.innerHeight||c.documentElement.clientHeight)&&g.right<=(b.innerWidth||c.documentElement.clientWidth)}}),a.fn.formSubmit=function(b){return this.each(function(){a.data(this,"plugin_formSubmit")||a.data(this,"plugin_formSubmit",new d(this,b))})}})(jQuery,window,document),jQuery(document).ready(function(a){a("[data-ajax-form=\"true\"]").formSubmit(),a(document).on("draw.dt",function(b){a(b.target).find("[data-ajax-form=\"true\"]").formSubmit()})});