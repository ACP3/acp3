"use strict";function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function _defineProperties(a,b){for(var c,d=0;d<b.length;d++)c=b[d],c.enumerable=c.enumerable||!1,c.configurable=!0,"value"in c&&(c.writable=!0),Object.defineProperty(a,c.key,c)}function _createClass(a,b,c){return b&&_defineProperties(a.prototype,b),c&&_defineProperties(a,c),a}/*
 * Copyright (c) by the ACP3 Developers.
 * See the LICENSE file at the top-level module directory for licencing details.
 */(function(a,b,c){'use strict';var d=/*#__PURE__*/function(){function d(b,c){_classCallCheck(this,d),this.element=b,this.isFormValid=!0,this._defaults={targetElement:"#content",loadingOverlay:!0,loadingText:"",customFormData:null,scrollOffsetElement:null},this.settings=a.extend({},this._defaults,c),this._name="formSubmit",this.init()}return _createClass(d,[{key:"init",value:function init(){var b=this,d=this;this.mergeSettings(),this.findSubmitButton(),this.addLoadingLayer(),this.element.noValidate=!0,a(this.element).on("submit",function(d){d.preventDefault(),b.isFormValid=!0,a(c).trigger("acp3.ajaxFrom.submit.before",[b]),b.isFormValid&&b.preValidateForm(b.element)&&b.processAjaxRequest()}).on("click",function(b){"A"===a(this).prop("tagName")&&(b.preventDefault(),d.processAjaxRequest())}).on("change",function(){!1===b.isFormValid&&(b.removeAllPreviousErrors(b.element),b.checkFormElementsForErrors(b.element))})}},{key:"mergeSettings",value:function mergeSettings(){var b=a(this.element).data();for(var c in b)if(b.hasOwnProperty(c)){var d=this.lowerCaseFirstLetter(c.replace("ajaxForm",""));0<d.length&&"undefined"!=typeof this.settings[d]&&(this.settings[d]=b[c])}}},{key:"lowerCaseFirstLetter",value:function lowerCaseFirstLetter(a){return a.charAt(0).toLowerCase()+a.slice(1)}},{key:"findSubmitButton",value:function findSubmitButton(){a(this.element).find(":submit").click(function(){a(":submit",a(this).closest("form")).removeAttr("data-clicked"),a(this).attr("data-clicked","true")})}},{key:"preValidateForm",value:function preValidateForm(a){return this.removeAllPreviousErrors(a),this.checkFormElementsForErrors(a),this.focusTabWithFirstErrorMessage(a),this.scrollToFirstFormError(),this.isFormValid}},{key:"removeAllPreviousErrors",value:function removeAllPreviousErrors(b){a(b).find(".is-invalid").removeClass(".is-invalid"),a(b).find(".invalid-feedback").remove()}},{key:"checkFormElementsForErrors",value:function checkFormElementsForErrors(b){var c=!0,d=!1,e=void 0;try{for(var f,g,h=b.elements[Symbol.iterator]();!(c=(f=h.next()).done);c=!0)(g=f.value,"INPUT"===g.nodeName||"TEXTAREA"===g.nodeName||"SELECT"===g.nodeName)&&(g.checkValidity()||(this.addErrorMessageToFormField(a(g),g.validationMessage),this.isFormValid=!1))}catch(a){d=!0,e=a}finally{try{c||null==h.return||h.return()}finally{if(d)throw e}}}},{key:"removeErrorMessageFromFormField",value:function removeErrorMessageFromFormField(a){a.closest("div").find(".invalid-feedback").remove()}},{key:"addErrorMessageToFormField",value:function addErrorMessageToFormField(a,b){this.removeErrorMessageFromFormField(a),a.addClass("is-invalid");a.closest("div:not(.input-group):not(.btn-group)").append("<div class=\"invalid-feedback d-block\"><i class=\"fas fa-exclamation-triangle\"></i> "+b+"</div>")}},{key:"focusTabWithFirstErrorMessage",value:function focusTabWithFirstErrorMessage(b){var c=a(b),d=c.find(".nav-tabs");if(0<d.length){var e=c.find(".tab-content .form-group:has(.invalid-feedback):first"),f=e.closest(".tab-pane").prop("id");d.find(".nav-link[href=\"#"+f+"\"]").tab("show"),e.find(":input").focus()}}},{key:"processAjaxRequest",value:function processAjaxRequest(){var d,e,f=this,g=a(this.element),h=!a.isEmptyObject(this.settings.customFormData),i=!0,j=this.settings.customFormData||{};if(g.attr("method")){if(e=a(":submit[data-clicked=\"true\"]",g),d=e.data("hashChange"),j=new FormData(g[0]),e.length&&j.append(e.attr("name"),1),h)for(var k in this.settings.customFormData)this.settings.customFormData.hasOwnProperty(k)&&j.append(k,this.settings.customFormData[k]);i=!1}else d=g.data("hashChange");a.ajax({url:g.attr("action")||g.attr("href"),type:g.attr("method")?g.attr("method").toUpperCase():"GET",data:j,processData:i,contentType:!!i&&"application/x-www-form-urlencoded; charset=UTF-8",beforeSend:function beforeSend(){f.showLoadingLayer(e),f.disableSubmitButton(e)}}).done(function(e){try{var h=g.data("ajax-form-complete-callback");"function"==typeof b[h]?b[h](e):e.redirect_url?f.redirectToNewPage(d,e):(f.scrollIntoView(),f.replaceContent(d,e),f.rebindHandlers(d),a(c).trigger("acp3.ajaxFrom.complete"),"undefined"!=typeof d&&(b.location.hash=d))}catch(a){console.error(a)}}).fail(function(b){400===b.status?(f.handleFormErrorMessages(g,b.responseText),f.scrollToFirstFormError(),a(c).trigger("acp3.ajaxFrom.submit.fail",[f])):0<b.responseText.length&&(c.open(),c.write(b.responseText),c.close())}).always(function(){f.hideLoadingLayer(),f.enableSubmitButton(e)})}},{key:"addLoadingLayer",value:function addLoadingLayer(){if(!1!==this.settings.loadingOverlay){var b=a("#loading-layer");if(0===b.length){var c=a("body"),d=this.settings.loadingText||"",e="<div id=\"loading-layer\" class=\"loading-layer\"><h1><span class=\"fas fa-cog fa-spin\"></span> ".concat(d,"</h1></div>");a(e).appendTo(c)}}}},{key:"showLoadingLayer",value:function showLoadingLayer(){a("#loading-layer").addClass("loading-layer__active")}},{key:"disableSubmitButton",value:function disableSubmitButton(a){"undefined"!=typeof a&&a.prop("disabled",!0)}},{key:"enableSubmitButton",value:function enableSubmitButton(a){"undefined"!=typeof a&&a.prop("disabled",!1)}},{key:"redirectToNewPage",value:function redirectToNewPage(a,c){"undefined"==typeof a?b.location.href=c.redirect_url:(b.location.href=c.redirect_url+a,b.location.reload())}/**
         * Scroll to the beginning of the content area, if the current viewport is near the bottom
         */},{key:"scrollIntoView",value:function scrollIntoView(){var b=a(this.settings.targetElement).offset().top;a(c).scrollTop()>b&&a("html, body").animate({scrollTop:b},"fast")}},{key:"replaceContent",value:function replaceContent(b,c){b&&a(b).length?a(b).html(a(c).find(b).html()):a(this.settings.targetElement).html(c)}},{key:"rebindHandlers",value:function rebindHandlers(b){var c=b&&a(b).length?a(b):a(this.settings.targetElement);c.find("[data-ajax-form=\"true\"]").formSubmit(),this.findSubmitButton()}},{key:"hideLoadingLayer",value:function hideLoadingLayer(){a("#loading-layer").removeClass("loading-layer__active")}},{key:"handleFormErrorMessages",value:function handleFormErrorMessages(b,c){var d=a("#error-box"),e=b.find(".modal-body");d.remove(),d=a(c),d.hide().prependTo(0<e.length&&e.is(":visible")?e:b).fadeIn(),this.prettyPrintResponseErrorMessages(b,d)}},{key:"prettyPrintResponseErrorMessages",value:function prettyPrintResponseErrorMessages(b,c){var d=this;this.removeAllPreviousErrors(this.element),c.find("li").each(function(c,e){var f=a(e),g=f.data("error");if(0<g.length){var h=b.find("#"+g)||b.find("[id|=\""+g+"\"]").filter(":not([id$=\"container\"])");0<h.length&&1===h.length&&(d.addErrorMessageToFormField(h,f.html()),f.remove())}}),0===c.find("li").length&&c.remove(),this.focusTabWithFirstErrorMessage(this.element)}},{key:"scrollToFirstFormError",value:function scrollToFirstFormError(){var b=a(this.element),c=b.find(".form-group.has-error");if(c&&0!==c.length&&!this.isElementInViewport(b.find(".help-block.validation-failed"))){var d=c.offset().top;if(this.settings.scrollOffsetElement){var e=a(this.settings.scrollOffsetElement);e&&0<e.length&&(d-=e.height())}a("html, body").animate({scrollTop:d},"fast")}}},{key:"isElementInViewport",value:function isElementInViewport(d){"function"==typeof jQuery&&d instanceof jQuery&&(d=d[0]);var e=a(this.settings.scrollOffsetElement),f=0;e&&(f=e.height());var g=d.getBoundingClientRect();return g.top>=f&&0<=g.left&&g.bottom<=(b.innerHeight||c.documentElement.clientHeight)&&g.right<=(b.innerWidth||c.documentElement.clientWidth)}}]),d}();a.fn.formSubmit=function(b){return this.each(function(){a.data(this,"plugin_formSubmit")||a.data(this,"plugin_formSubmit",new d(this,b))})}})(jQuery,window,document),jQuery(document).ready(function(a){a("[data-ajax-form=\"true\"]").formSubmit(),a(document).on("draw.dt",function(b){a(b.target).find("[data-ajax-form=\"true\"]").formSubmit()})});